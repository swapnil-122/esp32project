<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 DHT Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1b1b2f;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  h1 {
    margin-bottom: 15px;
    font-size: 2em;
    text-align: center;
    color: #f0f0f0;
  }

  .cards {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-bottom: 25px;
  }

  .card {
    background: #2c2c4a;
    border-radius: 20px;
    width: 150px;
    height: 130px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-shadow: 6px 6px 12px #181829, -6px -6px 12px #343460;
    transition: transform 0.2s, background 0.3s;
  }

  .card:hover { transform: scale(1.05); }

  .card h2 {
    margin: 0;
    font-size: 2.4em;
    transition: color 0.3s;
  }

  .card p {
    margin: 5px 0 0;
    font-size: 0.9em;
    color: #aaa;
  }

  .chart-container {
    width: 100%;
    max-width: 850px;
    background: #2c2c4a;
    padding: 20px;
    border-radius: 20px;
    box-shadow: 6px 6px 12px #181829, -6px -6px 12px #343460;
  }

  canvas { border-radius: 10px; }

  .footer {
    margin-top: 15px;
    font-size: 0.9em;
    color: #aaa;
  }

  @media(max-width:600px){
    .cards { gap: 15px; }
    .card { width: 130px; height: 110px; }
  }
</style>
</head>
<body>

<h1>ESP32 DHT Dashboard</h1>

<div class="cards">
  <div class="card" id="tempCardDiv">
    <h2 id="tempCard">-- °C</h2>
    <p>Temperature</p>
    <p id="tempMinMax"></p>
  </div>
  <div class="card" id="humCardDiv">
    <h2 id="humCard">-- %</h2>
    <p>Humidity</p>
    <p id="humMinMax"></p>
  </div>
</div>

<div class="chart-container">
  <canvas id="chart" height="200"></canvas>
</div>

<div class="footer" id="lastUpdated">Last Updated: --:--:--</div>

<script>
const FIREBASE_URL = "https://esp32dashboard-8623a-default-rtdb.firebaseio.com/dht.json";

let labels = [];
let tempData = [];
let humData = [];
let tempMin = null;
let tempMax = null;
let humMin = null;
let humMax = null;

const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Temperature (°C)',
        data: tempData,
        borderColor: '#FF6384',
        backgroundColor: ctx.createLinearGradient(0,0,0,200),
        tension: 0.3,
        fill: true,
      },
      {
        label: 'Humidity (%)',
        data: humData,
        borderColor: '#36A2EB',
        backgroundColor: ctx.createLinearGradient(0,0,0,200),
        tension: 0.3,
        fill: true,
      }
    ]
  },
  options: {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { labels: { color: '#fff' } } },
    scales: {
      x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
      y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
    }
  }
});

function fetchData() {
  fetch(FIREBASE_URL)
    .then(res => res.json())
    .then(data => {
      if(!data) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      
      labels.push(timeStr);
      tempData.push(data.temp);
      humData.push(data.hum);

      // Maintain last 20 readings
      if(labels.length > 20){
        labels.shift(); tempData.shift(); humData.shift();
      }

      chart.update();

      // Update cards
      document.getElementById('tempCard').innerText = data.temp + " °C";
      document.getElementById('humCard').innerText = data.hum + " %";

      // Track Min/Max
      tempMin = tempMin === null ? data.temp : Math.min(tempMin, data.temp);
      tempMax = tempMax === null ? data.temp : Math.max(tempMax, data.temp);
      humMin = humMin === null ? data.hum : Math.min(humMin, data.hum);
      humMax = humMax === null ? data.hum : Math.max(humMax, data.hum);

      document.getElementById('tempMinMax').innerText = `Min: ${tempMin} | Max: ${tempMax}`;
      document.getElementById('humMinMax').innerText = `Min: ${humMin} | Max: ${humMax}`;

      // Color alert if high temp or low humidity
      document.getElementById('tempCard').style.color = data.temp > 35 ? '#FF4500' : '#FF6384';
      document.getElementById('humCard').style.color = data.hum < 30 ? '#FF4500' : '#36A2EB';

      // Update timestamp
      document.getElementById('lastUpdated').innerText = "Last Updated: " + timeStr;

    })
    .catch(err => console.log("Fetch error: ", err));
}

setInterval(fetchData, 2000);
fetchData();
</script>

</body>
</html>
