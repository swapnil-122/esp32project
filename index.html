<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 DHT Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== Body & Layout ===== */
body {
  margin:0; font-family:'Segoe UI', sans-serif;
  background:#1b1b2f; color:#fff;
  display:flex; flex-direction:column; align-items:center; padding:20px;
}
h1 {
  margin-bottom:25px; font-size:2.2em;
  text-align:center; color:#f0f0f0;
  text-shadow: 1px 1px 5px rgba(0,0,0,0.5);
}
.cards {
  display:flex; flex-wrap:wrap; justify-content:center; gap:25px; margin-bottom:30px;
}
.card {
  background:#2c2c4a; border-radius:20px; width:180px; height:150px;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  position:relative;
  box-shadow: 8px 8px 15px #181829, -8px -8px 15px #343460;
  transition: transform 0.3s, box-shadow 0.3s;
}
.card:hover { transform: scale(1.05); box-shadow: 10px 10px 20px #181829, -10px -10px 20px #343460; }
.card h2 { margin:0; font-size:2.8em; transition: color 0.3s; }
.card p { margin:5px 0 0; font-size:0.9em; color:#aaa; text-align:center; }
.offline-overlay {
  position:absolute; top:0; left:0; right:0; bottom:0;
  background:rgba(27,27,47,0.85);
  display:flex; align-items:center; justify-content:center;
  color:#ff4c4c; font-weight:bold; font-size:1em; border-radius:20px;
  z-index:2; display:none; text-shadow:0 0 5px #000;
}
.chart-container {
  width:100%; max-width:950px; background:#2c2c4a;
  padding:25px 20px; border-radius:20px; box-shadow:8px 8px 15px #181829, -8px -8px 15px #343460;
  margin-bottom:20px;
}
canvas { border-radius:10px; }
.footer { font-size:0.9em; color:#aaa; text-align:center; }
@media(max-width:600px){
  .cards { gap:15px; }
  .card { width:140px; height:120px; }
  .card h2 { font-size:2em; }
}
</style>
</head>
<body>

<h1>ESP32 DHT Dashboard</h1>

<div class="cards">
  <div class="card" id="tempCardDiv">
    <div class="offline-overlay" id="tempOffline">Offline</div>
    <h2 id="tempCard">-- 째C</h2>
    <p>Temperature</p>
    <p id="tempMinMax"></p>
  </div>
  <div class="card" id="humCardDiv">
    <div class="offline-overlay" id="humOffline">Offline</div>
    <h2 id="humCard">-- %</h2>
    <p>Humidity</p>
    <p id="humMinMax"></p>
  </div>
</div>

<div class="chart-container">
  <canvas id="chart" height="250"></canvas>
</div>

<div class="footer" id="lastUpdated">Last Updated: --:--:--</div>

<script>
// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://esp32dashboard-8623a-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('dht');

// --- Chart Setup ---
const ctx = document.getElementById('chart').getContext('2d');
let labels=[], tempData=[], humData=[];
let tempMin=null, tempMax=null, humMin=null, humMax=null;

function getGradient(colorStart,colorEnd){
  const gradient=ctx.createLinearGradient(0,0,0,250);
  gradient.addColorStop(0,colorStart);
  gradient.addColorStop(1,colorEnd);
  return gradient;
}

const chart=new Chart(ctx,{
  type:'line',
  data:{
    labels:labels,
    datasets:[
      {label:'Temperature (째C)', data:tempData, borderColor:'#FF6384', backgroundColor:getGradient('rgba(255,99,132,0.4)','rgba(255,99,132,0)'), tension:0.3, fill:true, pointRadius:4, pointHoverRadius:6},
      {label:'Humidity (%)', data:humData, borderColor:'#36A2EB', backgroundColor:getGradient('rgba(54,162,235,0.4)','rgba(54,162,235,0)'), tension:0.3, fill:true, pointRadius:4, pointHoverRadius:6}
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:'index', intersect:false},
    plugins:{
      legend:{labels:{color:'#fff'}},
      tooltip:{backgroundColor:'#2c2c4a', titleColor:'#fff', bodyColor:'#fff'}
    },
    scales:{
      x:{ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'}},
      y:{ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'}}
    }
  }
});

function updateCard(id,value,alert=false,alertColor='#FF4500',normalColor='#fff'){
  const el=document.getElementById(id);
  el.innerText=value;
  el.style.color=alert?alertColor:normalColor;
}

function updateOffline(isOffline){
  document.getElementById('tempOffline').style.display=isOffline?'flex':'none';
  document.getElementById('humOffline').style.display=isOffline?'flex':'none';
}

// --- Firebase Realtime Listener ---
let lastTimestamp=0;
dbRef.on('value', snapshot => {
  const data = snapshot.val();
  if(!data) return;

  const now = new Date();
  const timeStr = now.toLocaleTimeString();
  const ts = data.timestamp || now.getTime();

  // offline if no new data in 10s
  const offline = (Date.now() - ts) > 10000;
  updateOffline(offline);
  if(offline){
    updateCard('tempCard','-- 째C'); updateCard('humCard','-- %');
    document.getElementById('lastUpdated').innerText = "ESP32 Offline";
    return;
  }

  // ignore duplicates
  if(ts <= lastTimestamp) return;
  lastTimestamp = ts;

  // Chart update
  labels.push(timeStr); tempData.push(data.temp); humData.push(data.hum);
  if(labels.length>20){ labels.shift(); tempData.shift(); humData.shift(); }
  chart.update();

  // Min/Max tracking
  tempMin = tempMin===null?data.temp:Math.min(tempMin,data.temp);
  tempMax = tempMax===null?data.temp:Math.max(tempMax,data.temp);
  humMin = humMin===null?data.hum:Math.min(humMin,data.hum);
  humMax = humMax===null?data.hum:Math.max(humMax,data.hum);
  document.getElementById('tempMinMax').innerText = `Min: ${tempMin} | Max: ${tempMax}`;
  document.getElementById('humMinMax').innerText = `Min: ${humMin} | Max: ${humMax}`;

  // Update cards with alerts
  updateCard('tempCard', data.temp+' 째C', data.temp>35);
  updateCard('humCard', data.hum+' %', data.hum<30);
  document.getElementById('lastUpdated').innerText = "Last Updated: "+timeStr;
});
</script>

</body>
</html>
