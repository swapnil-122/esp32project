<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 DHT Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0; font-family:'Segoe UI', sans-serif;
  background:#1b1b2f; color:#fff; padding:15px;
}
h1 { text-align:center; margin-bottom:20px; font-size:1.8em; }
.cards {
  display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-bottom:20px;
}
.card {
  background:#2c2c4a; border-radius:12px; width:150px; height:120px;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  position:relative; padding:8px;
}
.card h2 { margin:0; font-size:2em; }
.card p { margin:4px 0 0; font-size:0.8em; color:#aaa; text-align:center; }
.offline-overlay {
  position:absolute; top:0; left:0; right:0; bottom:0;
  background:rgba(27,27,47,0.8);
  display:flex; align-items:center; justify-content:center;
  color:#ff4c4c; font-weight:bold; font-size:0.9em; border-radius:12px;
  display:none;
}
.chart-container {
  width:100%; max-width:900px; background:#2c2c4a;
  padding:15px; border-radius:12px; margin-bottom:15px;
}
canvas { border-radius:8px; }
.footer { font-size:0.85em; color:#aaa; text-align:center; }
@media(max-width:450px){
  .cards { gap:8px; }
  .card { width:130px; height:110px; }
  .card h2 { font-size:1.6em; }
}
</style>
</head>
<body>

<h1>ESP32 DHT Dashboard</h1>

<div class="cards">
  <div class="card" id="tempCardDiv">
    <div class="offline-overlay" id="tempOffline">Offline</div>
    <h2 id="tempCard">-- 째C</h2>
    <p>Temperature</p>
    <p id="tempMinMax"></p>
  </div>
  <div class="card" id="humCardDiv">
    <div class="offline-overlay" id="humOffline">Offline</div>
    <h2 id="humCard">-- %</h2>
    <p>Humidity</p>
    <p id="humMinMax"></p>
  </div>
</div>

<div class="chart-container">
  <canvas id="chart" height="200"></canvas>
</div>

<div class="footer" id="lastUpdated">Last Updated: --:--:--</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://esp32dashboard-8623a-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('dht');

// Chart Setup
const ctx = document.getElementById('chart').getContext('2d');
let labels=[], tempData=[], humData=[];
let tempMin=null, tempMax=null, humMin=null, humMax=null;

const chart = new Chart(ctx, {
  type:'line',
  data:{
    labels: labels,
    datasets:[
      {label:'Temperature (째C)', data: tempData, borderColor:'#FF6384', backgroundColor:'rgba(255,99,132,0.2)', tension:0.2, fill:true},
      {label:'Humidity (%)', data: humData, borderColor:'#36A2EB', backgroundColor:'rgba(54,162,235,0.2)', tension:0.2, fill:true}
    ]
  },
  options:{
    responsive:true,
    interaction:{mode:'index', intersect:false},
    plugins:{legend:{labels:{color:'#fff'}}, tooltip:{backgroundColor:'#2c2c4a', titleColor:'#fff', bodyColor:'#fff'}},
    scales:{x:{ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'}}, y:{ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'}}}
  }
});

function updateCard(id,value,alert=false,alertColor='#FF4500',normalColor='#fff'){
  const el=document.getElementById(id);
  el.innerText=value;
  el.style.color=alert?alertColor:normalColor;
}

function updateOffline(isOffline){
  document.getElementById('tempOffline').style.display=isOffline?'flex':'none';
  document.getElementById('humOffline').style.display=isOffline?'flex':'none';
}

// Firebase Realtime Listener
let lastTimestamp=0;
dbRef.on('value', snapshot => {
  const data = snapshot.val();
  if(!data) return;

  const now = new Date();
  const timeStr = now.toLocaleTimeString();
  const ts = data.timestamp || now.getTime();

  const offline = (Date.now() - ts) > 10000;
  updateOffline(offline);
  if(offline){
    updateCard('tempCard','-- 째C'); updateCard('humCard','-- %');
    document.getElementById('lastUpdated').innerText = "ESP32 Offline";
    return;
  }

  if(ts <= lastTimestamp) return; // ignore duplicates
  lastTimestamp = ts;

  // Chart update
  labels.push(timeStr); tempData.push(data.temp); humData.push(data.hum);
  if(labels.length>20){ labels.shift(); tempData.shift(); humData.shift(); }
  chart.update();

  // Min/Max tracking
  tempMin = tempMin===null?data.temp:Math.min(tempMin,data.temp);
  tempMax = tempMax===null?data.temp:Math.max(tempMax,data.temp);
  humMin = humMin===null?data.hum:Math.min(humMin,data.hum);
  humMax = humMax===null?data.hum:Math.max(humMax,data.hum);
  document.getElementById('tempMinMax').innerText = `Min: ${tempMin} | Max: ${tempMax}`;
  document.getElementById('humMinMax').innerText = `Min: ${humMin} | Max: ${humMax}`;

  // Update cards with alert colors
  updateCard('tempCard', data.temp+' 째C', data.temp>35);
  updateCard('humCard', data.hum+' %', data.hum<30);
  document.getElementById('lastUpdated').innerText = "Last Updated: "+timeStr;
});
</script>

</body>
</html>
